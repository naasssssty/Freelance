pipeline {
    agent any
    
    tools {
        nodejs 'Node 21'
    }
    
    environment {
        DOCKER_REPO = 'papadooo/freelance-frontend'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        IMAGE_NAME = "${DOCKER_REPO}:${IMAGE_TAG}"
        LATEST_IMAGE = "${DOCKER_REPO}:latest"
        NODE_ENV = 'production'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        skipDefaultCheckout()
    }
    
    stages {
        stage('ğŸš€ Pipeline Start') {
            steps {
                script {
                    echo "ğŸš€ Starting Frontend Pipeline"
                    echo "ğŸ“‹ Build Number: ${env.BUILD_NUMBER}"
                    echo "ğŸŒ¿ Branch: ${env.BRANCH_NAME ?: 'test-branch'}"
                    echo "ğŸ·ï¸ Image Tag: ${IMAGE_TAG}"
                    echo "ğŸ“… Build Time: ${new Date()}"
                }
            }
        }
        
        stage('ğŸ§¹ Cleanup & Checkout') {
            steps {
                script {
                    echo "ğŸ§¹ Cleaning workspace..."
                    cleanWs()
                    
                    echo "ğŸ“¥ Checking out source code..."
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: '*/test-branch']],
                        extensions: [
                            [$class: 'CloneOption', depth: 1, noTags: false, reference: '', shallow: true]
                        ],
                        userRemoteConfigs: [[
                            url: 'https://github.com/naasssssty/Freelance.git'
                        ]]
                    ])
                }
            }
        }
        
        stage('ğŸ” Code Analysis') {
            parallel {
                stage('ğŸ“Š Code Quality') {
                    steps {
                        dir('frontend') {
                            echo "ğŸ“Š Running code quality checks..."
                            sh 'npm install --only=dev || npm install'
                            sh 'npx eslint src/ --format junit --output-file eslint-report.xml || true'
                            sh 'npm audit --audit-level moderate || true'
                        }
                    }
                }
                
                stage('ğŸ” Security Scan') {
                    steps {
                        dir('frontend') {
                            echo "ğŸ” Running security checks..."
                            sh '''
                                echo "Checking for potential secrets..."
                                grep -r -i "password\\|secret\\|key\\|token" src/ --exclude-dir=node_modules || echo "No sensitive data found"
                                echo "Checking package dependencies..."
                                npm audit --audit-level high || echo "Audit completed"
                            '''
                        }
                    }
                }
            }
        }
        
        stage('ğŸ“¦ Install Dependencies') {
            steps {
                dir('frontend') {
                    echo "ğŸ“¦ Installing npm dependencies..."
                    sh '''
                        echo "Node version: $(node --version)"
                        echo "NPM version: $(npm --version)"
                        npm ci --prefer-offline --no-audit || npm install
                        echo "âœ… Dependencies installed successfully"
                    '''
                }
            }
        }
        
        stage('ğŸ§ª Run Tests') {
            parallel {
                stage('ğŸ§ª Unit Tests') {
                    steps {
                        dir('frontend') {
                            echo "ğŸ§ª Running unit tests..."
                            sh '''
                                CI=true npm test -- --coverage --watchAll=false --passWithNoTests || true
                                echo "âœ… Unit tests completed"
                            '''
                        }
                    }
                    post {
                        always {
                            script {
                                try {
                                    if (fileExists('frontend/coverage/lcov-report/index.html')) {
                                        publishHTML([
                                            allowMissing: false,
                                            alwaysLinkToLastBuild: true,
                                            keepAll: true,
                                            reportDir: 'frontend/coverage/lcov-report',
                                            reportFiles: 'index.html',
                                            reportName: 'Coverage Report'
                                        ])
                                    }
                                } catch (Exception e) {
                                    echo "Could not publish coverage report: ${e.getMessage()}"
                                }
                            }
                        }
                    }
                }
                
                stage('ğŸ”§ Integration Tests') {
                    steps {
                        dir('frontend') {
                            echo "ğŸ”§ Running integration tests..."
                            sh '''
                                echo "Testing build process..."
                                npm run build
                                
                                if [ -d "build" ]; then
                                    echo "âœ… Build directory created successfully"
                                    ls -la build/ | head -10
                                else
                                    echo "âŒ Build failed - no build directory found"
                                    exit 1
                                fi
                            '''
                        }
                    }
                }
            }
        }
        
        stage('ğŸ—ï¸ Build Application') {
            steps {
                dir('frontend') {
                    echo "ğŸ—ï¸ Building React application..."
                    sh '''
                        echo "Building for production..."
                        export REACT_APP_ENV=production
                        export GENERATE_SOURCEMAP=false
                        
                        npm run build
                        
                        if [ -d "build" ] && [ "$(ls -A build)" ]; then
                            echo "âœ… Build completed successfully"
                            echo "ğŸ“Š Build size: $(du -sh build/)"
                            echo "ğŸ“ Build contents:"
                            ls -la build/ | head -10
                        else
                            echo "âŒ Build failed or empty"
                            exit 1
                        fi
                    '''
                }
            }
        }
        
        stage('ğŸ³ Docker Build') {
            steps {
                script {
                    echo "ğŸ³ Building Docker image..."
                    sh '''
                        echo "Building Docker image: ${IMAGE_NAME}"
                        
                        docker build \
                            -f docker/Dockerfile.frontend \
                            -t ${IMAGE_NAME} \
                            -t ${LATEST_IMAGE} \
                            --build-arg NODE_ENV=production \
                            --label "build.number=${BUILD_NUMBER}" \
                            --label "build.date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                            frontend/
                        
                        echo "âœ… Docker image built successfully"
                        docker images | grep freelance-frontend || true
                    '''
                }
            }
        }
        
        stage('ğŸ§ª Container Test') {
            steps {
                script {
                    echo "ğŸ§ª Testing Docker container..."
                    sh '''
                        echo "ğŸš€ Starting container for testing..."
                        
                        # Start container
                        CONTAINER_ID=$(docker run -d -p 3001:80 --name frontend-test-${BUILD_NUMBER} ${IMAGE_NAME})
                        echo "Container ID: $CONTAINER_ID"
                        
                        # Wait and test
                        sleep 15
                        
                        # Health check
                        for i in {1..5}; do
                            if curl -f http://localhost:3001 > /dev/null 2>&1; then
                                echo "âœ… Health check passed on attempt $i"
                                break
                            else
                                echo "â³ Retrying health check... ($i/5)"
                                sleep 5
                            fi
                            
                            if [ $i -eq 5 ]; then
                                echo "âŒ Health check failed"
                                docker logs frontend-test-${BUILD_NUMBER} || true
                                exit 1
                            fi
                        done
                        
                        # Test content
                        RESPONSE=$(curl -s http://localhost:3001 || echo "curl failed")
                        if echo "$RESPONSE" | grep -q "FreelancerProject\\|React App\\|root"; then
                            echo "âœ… Application serving content correctly"
                        else
                            echo "âŒ Application not responding correctly"
                            echo "Response sample: ${RESPONSE:0:200}..."
                            exit 1
                        fi
                    '''
                }
            }
            post {
                always {
                    sh '''
                        echo "ğŸ§¹ Cleaning up test container..."
                        docker stop frontend-test-${BUILD_NUMBER} || true
                        docker rm frontend-test-${BUILD_NUMBER} || true
                    '''
                }
            }
        }
        
        stage('ğŸ“¤ Push to Registry') {
            when {
                anyOf {
                    branch 'main'
                    branch 'test-branch'
                    branch 'develop'
                }
            }
            steps {
                echo "ğŸ“¤ Pushing Docker image to registry..."
                withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                    sh '''
                        echo "ğŸ” Logging into Docker registry..."
                        echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
                        
                        echo "ğŸ“¤ Pushing images..."
                        docker push ${IMAGE_NAME}
                        docker push ${LATEST_IMAGE}
                        
                        echo "âœ… Images pushed successfully"
                        echo "ğŸ·ï¸ Tagged as: ${IMAGE_NAME}"
                        echo "ğŸ·ï¸ Tagged as: ${LATEST_IMAGE}"
                    '''
                }
            }
        }
        
        stage('ğŸš€ Deploy Staging') {
            when {
                anyOf {
                    branch 'test-branch'
                    branch 'develop'
                }
            }
            steps {
                echo "ğŸš€ Deploying to staging..."
                sh '''
                    echo "ğŸ”§ Preparing deployment..."
                    
                    # Stop existing container
                    docker stop freelance-frontend-staging || true
                    docker rm freelance-frontend-staging || true
                    
                    # Run new container
                    docker run -d \
                        --name freelance-frontend-staging \
                        --restart unless-stopped \
                        -p 3000:80 \
                        -e NODE_ENV=production \
                        ${IMAGE_NAME}
                    
                    echo "âœ… Deployment completed"
                    
                    # Verify deployment
                    sleep 15
                    if curl -f http://localhost:3000 > /dev/null 2>&1; then
                        echo "âœ… Staging deployment successful"
                        echo "ğŸŒ Application available at: http://localhost:3000"
                    else
                        echo "âŒ Staging deployment failed"
                        docker logs freelance-frontend-staging || true
                        exit 1
                    fi
                '''
            }
        }
        
        stage('ğŸ¥ Health Check') {
            when {
                anyOf {
                    branch 'test-branch'
                    branch 'develop'
                }
            }
            steps {
                echo "ğŸ¥ Running health checks..."
                sh '''
                    echo "ğŸ” Checking application health..."
                    sleep 10
                    
                    # Test endpoints
                    for endpoint in "/" "/static/js" "/static/css"; do
                        echo "Testing: $endpoint"
                        if curl -f "http://localhost:3000$endpoint" > /dev/null 2>&1; then
                            echo "âœ… $endpoint accessible"
                        else
                            echo "âš ï¸ $endpoint might not be accessible"
                        fi
                    done
                    
                    # Check React app
                    RESPONSE=$(curl -s http://localhost:3000 || echo "curl failed")
                    if echo "$RESPONSE" | grep -q "root\\|React"; then
                        echo "âœ… React application loading correctly"
                    else
                        echo "âš ï¸ React application might have issues"
                    fi
                    
                    echo "ğŸ¥ Health check completed"
                '''
            }
        }
    }
    
    post {
        always {
            echo "ğŸ§¹ Pipeline cleanup..."
            sh '''
                # Clean up test containers
                docker ps -a | grep "frontend-test-" | awk '{print $1}' | xargs -r docker rm -f || true
                
                # Clean up dangling images
                docker image prune -f || true
                
                echo "âœ… Cleanup completed"
            '''
            
            // Archive artifacts
            script {
                try {
                    if (fileExists('frontend/build')) {
                        archiveArtifacts artifacts: 'frontend/build/**/*', fingerprint: true, allowEmptyArchive: true
                    }
                    if (fileExists('frontend/coverage')) {
                        archiveArtifacts artifacts: 'frontend/coverage/**/*', fingerprint: true, allowEmptyArchive: true
                    }
                } catch (Exception e) {
                    echo "Could not archive artifacts: ${e.getMessage()}"
                }
            }
        }
        
        success {
            echo "ğŸ‰ Frontend Pipeline completed successfully!"
            script {
                def message = """
ğŸ‰ Frontend Build Successful! 
ğŸ“‹ Build: #${env.BUILD_NUMBER}
ğŸŒ¿ Branch: ${env.BRANCH_NAME ?: 'test-branch'}
ğŸ·ï¸ Image: ${IMAGE_NAME}
â±ï¸ Duration: ${currentBuild.durationString}
ğŸŒ Staging: http://localhost:3000
"""
                echo message
            }
        }
        
        failure {
            echo "âŒ Frontend Pipeline failed!"
            script {
                def message = """
âŒ Frontend Build Failed!
ğŸ“‹ Build: #${env.BUILD_NUMBER}
ğŸŒ¿ Branch: ${env.BRANCH_NAME ?: 'test-branch'}
â±ï¸ Duration: ${currentBuild.durationString}
ğŸ“‹ Logs: ${env.BUILD_URL}console
"""
                echo message
            }
        }
        
        unstable {
            echo "âš ï¸ Frontend Pipeline completed with warnings!"
        }
        
        aborted {
            echo "ğŸ›‘ Frontend Pipeline was aborted!"
        }
    }
}